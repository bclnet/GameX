=== Binary Formats

==== Binary: Ba2
The BA2 file format

There is a single format of a BA2 file, we use magic to determine which.

===== Fallout 4 - Starfield
The BA2 file format for Fallout4 through Starfield

if magic = F4_BSAHEADER_FILEID: 

[cols="1,2,2,6"]
|===
|ID |Field |Type |Description

// HDR
.5+|*HDR*
3+|*Header*

|Version
|uint:4
|

|Type
|uint:4
|GNRL=General, DX10=Textures, GNMF=

|NumFiles
|uint:4
|

|NameTableOffset
|ulong:8
|Relative to start of file

// FILE
.9+|*FILE*
3+|*File*

|NameHash
|uint:4
|

|Ext
|ascii:4
|extension

|DirHash
|uint:4
|

|Flags
|uint:4
|Flags: 00100100

|Offset
|ulong:8
|Relative to start of file

|PackedSize
|uint:4
|Packed length (zlib)

|FileSize
|uint:4
|Unpacked length

|Align
|uint:4
|BAADF00D

// TEX
.13+|*TEX*
3+|*Texture*

|NameHash
|uint:4
|

|Ext
|ascii:4
|extension

|DirHash
|uint:4
|

|Unk0C
|byte:1
|

|NumChunks
|byte:1
|

|ChunkHeaderSize
|ushort:2
|Size of one chunk header

|Height
|ushort:2
|

|Width
|ushort:2
|

|NumMips
|byte:1
|

|Format
|byte:1
|DXGI_FORMAT

|IsCubemap
|byte:1
|

|TileMode
|byte:1
|

// GNMF
.13+|*GNMF*
3+|*Texture*

|NameHash
|uint:4
|

|Ext
|ascii:4
|extension

|DirHash
|uint:4
|

|Unk0C
|byte:1
|

|NumChunks
|byte:1
|

|Unk0E
|ushort:2
|

|Header
|bytes:32
|

|Offset
|ulong:8
|

|PackedSize
|uint:4
|

|FileSize
|uint:4
|

|Unk40
|uint:4
|

|Align
|uint:4
|

// TEXC
.7+|*TEXC*
3+|*Texture Chunk*

|Offset
|ulong:8
|

|PackedSize
|uint:4
|

|FileSize
|uint:4
|

|StartMip
|ushort:2
|

|EndMip
|ushort:2
|

|Align
|uint:4
|
|===

To access a FILE
[,python]
----
r.seek(file.position)
# General BA2 Format
if file.fileInfo == null:
    return
        decompressZlib2(r, file.packedSize, file.fileSize) if file.compressed != 0 else \
        r.read(file.fileSize)

----

==== Source code
[,python]
----
include::../../../../python/gamex/families/Bethesda/formats/binary.py[tag=Binary_Ba2]
----


==== Binary: Bsa
The BSA file format

There are two formats of a BSA file, we use magic to determine which.

===== Oblivion - Skyrim
The BSA file format for Oblivion through Skyrim

if magic = OB_BSAHEADER_FILEID:

[cols="1,2,2,6"]
|===
|ID |Type |Field |Description

.9+|HDR
2+|
|*Header*

|uint:4
|version
|04

|uint:4
|folderRecordOffset
|Offset of beginning of folder records

|uint:4
|archiveFlags
|Archive flags

|uint:4
|folderCount
|Total number of folder records (OBBSAFolderInfo)

|uint:4
|fileCount
|Total number of file records (OBBSAFileInfo)

|uint:4
|folderNameLength
|Total length of folder names

|uint:4
|fileNameLength
|Total length of file names

|uint:4
|fileFlags
|File flags

.4+|FLDR1
2+|repeat: folderCount
|*Folder* (SSE)

|ulong:8
|hash
|Hash of the folder name

|uint:4
|fileCount
|Number of files in folder

|uint:4
|offset
|The offset

.5+|FLDR2
2+|repeat: folderCount
|*Folder* (not SSE)

|ulong:8
|hash
|Hash of the folder name

|uint:4
|fileCount
|Number of files in folder

|uint:4
|unk
|Unknown

|ulong:8
|offset
|The offset

.3+|FLNM
2+|repeat: folderCount
|*Folder Name*

|ascii:l8-1
|folderName
|The folder name

|byte:1
|unk
|Unknown

.4+|FILE
2+|repeat: fileCount
|*File*

|ulong:8
|hash
|Hash of the filename

|uint:4
|size
|Size of the data, possibly with OB_BSAFILE_SIZECOMPRESS set

|uint:4
|offset
|Offset to raw file data
|===

===== Morrowind
The BSA file format for Morrowind

if magic = MW_BSAHEADER_FILEID

[cols="1,2,2,6"]
|===
|ID |Type |Field |Description

.3+|HDR
2+|
|*Header*

|uint:4
|HashOffset
|Offset of hash table minus header size (12)

|uint:4
|fileCount
|Number of files in the archive

.4+|FILE
2+|repeat: fileCount
|*File*

|uint:4
|fileSize
|File size

|uint:4
|fileOffset
|File offset relative to data position

|formula:-
|getSize()
|The size of the file inside the BSA

.2+|FNOFF
2+|repeat: fileCount
|*Filename Offsets*

|uint:4
|offset
|Offset

.2+|FNAME
2+|repeat: fileCount, seek: filenameOffsets
|*Filenames*

|cstr:+
|path
|File path
|===

To access a FILE
[,python]
----
fileSize = file.packedSize & self.OB_BSAFILE_SIZEMASK if source.version == self.SSE_BSAHEADER_VERSION else file.packedSize
r.seek(file.position)
if source.params['namePrefix'] == 'Y':
    prefixLength = r.readByte() + 1
    if source.version == self.SSE_BSAHEADER_VERSION: fileSize -= prefixLength
    r.seek(file.position + prefixLength)

# not compressed
if fileSize <= 0 or file.compressed == 0:
    return r.read(fileSize)

# compressed
newFileSize = r.readUInt32(); fileSize -= 4
return
    decompressLz4(r, fileSize, newFileSize) if source.version == self.SSE_BSAHEADER_VERSION else \
    decompressZlib2(r, fileSize, newFileSize)
----

==== Source code
[,python]
----
include::../../../../python/gamex/families/Bethesda/formats/binary.py[tag=Binary_Bsa]
----
