=== Binary Formats
These are the Bethesda binary formats.

==== Binary: Ba2
The Bethesda *.BA2* file format is a archive format, we use magic to determine which format:

==== Fallout 4 through Starfield (F4_MAGIC):
The Bethesda *.BA2* file format for Fallout4 through Starfield.

    F4_MAGIC = 0x58445442:: Magic for Fallout 4 BA2, the literal string "BTDX".
    F4_VERSION1 = 0x01:: Version number of a Fallout 4 BA2
    F4_VERSION2 = 0x02:: Version number of a Starfield BA2

[cols="1,2,2,6"]
|===
|ID |Field |Type |Description
|*HDR5Type* 3+|*Enum*
4+a|
!===
!GNRL = 0x4c524e47 !DX10 = 0x30315844 !GNMF = 0x464d4e47
!===

.5+|*HDR5* 3+|*Header*
|Version |uint:4 |
|Type |uint:4 |GNRL=General, DX10=Textures, GNMF=
|NumFiles |uint:4 |
|NameTableOffset |ulong:8 |Relative to start of file
4+a|
[,python]
----
include::../../../../python/gamex/families/Bethesda/formats/binary.py[tag=Binary_Ba2.HDR5]
----

.9+|*FILE5* 3+|*File*
|NameHash |uint:4 |
|Ext |ascii:4 |Extension
|DirHash |uint:4 |
|Flags |uint:4 |Flags: 00100100
|Offset |ulong:8 |Relative to start of file
|PackedSize |uint:4 |Packed length (zlib)
|FileSize |uint:4 |Unpacked length
|Align |uint:4 |BAADF00D
4+a|
[,python]
----
include::../../../../python/gamex/families/Bethesda/formats/binary.py[tag=Binary_Ba2.FILE5]
----

.13+|*TEX5* 3+|*Texture*
|NameHash |uint:4 |
|Ext |ascii:4 |Extension
|DirHash |uint:4 |
|Unk0C |byte:1 |
|NumChunks |byte:1 |
|ChunkHeaderSize |ushort:2 |Size of one chunk header
|Height |ushort:2 |
|Width |ushort:2 |
|NumMips |byte:1 |
|Format |byte:1 |DXGI_FORMAT
|IsCubemap |byte:1 |
|TileMode |byte:1 |
4+a|
[,python]
----
include::../../../../python/gamex/families/Bethesda/formats/binary.py[tag=Binary_Ba2.TEX5]
----

.7+|*TEXC5* 3+|*Texture Chunk*
|Offset |ulong:8 |
|PackedSize |uint:4 |
|FileSize |uint:4 |
|StartMip |ushort:2 |
|EndMip |ushort:2 |
|Align |uint:4 |
4+a|
[,python]
----
include::../../../../python/gamex/families/Bethesda/formats/binary.py[tag=Binary_Ba2.TEXC5]
----

.13+|*GNMF5* 3+|*Texture*
|NameHash |uint:4 |
|Ext |ascii:4 |Extension
|DirHash |uint:4 |
|Unk0C |byte:1 |
|NumChunks |byte:1 |
|Unk0E |ushort:2 |
|Header |bytes:32 |
|Offset |ulong:8 |
|PackedSize |uint:4 |
|FileSize |uint:4 |
|Unk40 |uint:4 |
|Align |uint:4 |
4+a|
[,python]
----
include::../../../../python/gamex/families/Bethesda/formats/binary.py[tag=Binary_Ba2.GNMF5]
----

.2+|*Read* 3+|*Method*
3+|Reads the value
4+a|
[,python]
----
include::../../../../python/gamex/families/Bethesda/formats/binary.py[tag=Binary_Ba2.read]
----

.2+|*ReadData* 3+|*Method*
3+|Reads the data
4+a|
[,python]
----
include::../../../../python/gamex/families/Bethesda/formats/binary.py[tag=Binary_Ba2.readData]
----
|===

==== Binary: Bsa
The Bethesda *.BSA* file format is a archive format, we use magic to determine which format:

===== Oblivion through Skyrim (OB_MAGIC)
The Bethesda *.BSA* file format for Oblivion through Skyrim.

    OB_MAGIC = 0x00415342:: Magic for Oblivion BSA, the literal string "BSA\0".
    OB_VERSION = 0x67:: Version number of an Oblivion BSA
    F3_VERSION = 0x68:: Version number of a Fallout 3 BSA
    SE_VERSION = 0x69:: Version number of a Skyrim SE BSA

    FLAG4_PATHNAMES = 0x0001:: Whether the BSA has names for paths
    FLAG4_FILENAMES = 0x0002:: Whether the BSA has names for files
    FLAG4_COMPRESSFILES = 0x0004:: Whether the files are compressed
    FLAG4_PREFIXS = 0x0100:: Whether the name is prefixed to the data

    FILE4_SIZEMASK = 0x3fffffff:: Bit mask with OB_HeaderFile:SizeFlags to get the compression status
    FILE4_SIZECOMPRESS = 0xC0000000:: Bit mask with OB_HeaderFile:SizeFlags to get the compression status

[cols="1,2,2,6"]
|===
|ID |Type |Field |Description

.9+|*HDR4* 2+| |*Header*
|Version |uint:4 |04
|FolderRecordOffset |uint:4 |Offset of beginning of folder records
|ArchiveFlags |uint:4 |Archive flags
|FolderCount |uint:4 |Total number of folder records (OBBSAFolderInfo)
|FileCount |uint:4 |Total number of file records (OBBSAFileInfo)
|FolderNameLength |uint:4 |Total length of folder names
|FileNameLength |uint:4 |Total length of file names
|FileFlags |uint:4 |File flags
4+a|
[,python]
----
include::../../../../python/gamex/families/Bethesda/formats/binary.py[tag=Binary_Bsa.HDR4]
----

.4+|*DIR4* 2+|repeat: folderCount |*Directory*
|Hash |ulong:8 |Hash of the folder name
|FileCount |uint:4 |Number of files in folder
|Offset |uint:4 |The offset
4+a|
[,python]
----
include::../../../../python/gamex/families/Bethesda/formats/binary.py[tag=Binary_Bsa.DIR4]
----

.5+|*DIR4SE* 2+|repeat: folderCount |*Directory*
|Hash |ulong:8 |Hash of the folder name
|FileCount |uint:4 |Number of files in folder
|Unk |uint:4 |Unknown
|Offset |ulong:8 |The offset
4+a|
[,python]
----
include::../../../../python/gamex/families/Bethesda/formats/binary.py[tag=Binary_Bsa.DIR4SE]
----

// .3+|*FLNM* 2+|repeat: folderCount |*Folder Name*
// |ascii:l8-1 |folderName |The folder name
// |Unk |byte:1 |Unknown
// 4+a|
// [,python]
// ----
// include::../../../../python/gamex/families/Bethesda/formats/binary.py[tag=Binary_Bsa.FILE5]
// ----

.4+|*FILE4* 2+|repeat: fileCount |*File*
|Hash |ulong:8 |Hash of the filename
|Size |uint:4 |Size of the data, possibly with OB_BSAFILE_SIZECOMPRESS set
|Offset |uint:4 |Offset to raw file data
4+a|
[,python]
----
include::../../../../python/gamex/families/Bethesda/formats/binary.py[tag=Binary_Bsa.FILE4]
----
|===

===== Morrowind (OB_MAGIC)
The Bethesda *.BSA* file format for Morrowind.

    MW_MAGIC = 0x00000100:: Magic for Morrowind BSA

[cols="1,2,2,6"]
|===
|ID |Type |Field |Description

.3+|*HDR3* 2+| |*Header*
|HashOffset |uint:4 |Offset of hash table minus header size (12)
|FileCount |uint:4 |Number of files in the archive
4+a|
[,python]
----
include::../../../../python/gamex/families/Bethesda/formats/binary.py[tag=Binary_Bsa.HDR3]
----

.4+|*FILE3* 2+|repeat: fileCount |*File*
|FileSize |uint:4 |File size
|FileOffset |uint:4 |File offset relative to data position
|Size |{formula} |The size of the file inside the BSA
4+a|
[,python]
----
include::../../../../python/gamex/families/Bethesda/formats/binary.py[tag=Binary_Bsa.FILE3]
----

.2+|*FNOF3* 2+|repeat: fileCount |*Filename Offsets*
|offset |uint:4 |Offset

.2+|*FNAM3* 2+|repeat: fileCount, seek: filenameOffsets |*Filenames*
|path |cstr:+ |File path

.2+|*Read* 3+|*Method*
3+|Reads the value
4+a|
[,python]
----
include::../../../../python/gamex/families/Bethesda/formats/binary.py[tag=Binary_Bsa.read]
----

.2+|*ReadData* 3+|*Method*
3+|Reads the data
4+a|
[,python]
----
include::../../../../python/gamex/families/Bethesda/formats/binary.py[tag=Binary_Bsa.readData]
----
|===

